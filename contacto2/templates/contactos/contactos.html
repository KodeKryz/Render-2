{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Contactos</title>
    <style>
        body{ font-family: Arial, sans-serif; padding: 2rem }
        table{ border-collapse: collapse; width: 100% }
        th, td{ border: 1px solid #ddd; padding: 8px }
        th{ background:#f4f4f4 }
        pre{ 
            background:#f8f8f8;
            border:1px solid #ddd;
            padding:1rem;
            white-space:pre-wrap; /* Permite saltos de línea largos */
            word-wrap:break-word; /* Asegura que no desborde la caja */
        }
    </style>
</head>
<body>
    <h1>Contactos</h1>

    {# Mostrar estado de autenticación #}
    {% if request.session.external_api_user %}
        <p>Usuario (API externa): <strong>{{ request.session.external_api_user }}</strong></p>
    {% elif user %}
        <p>Usuario: <strong>{{ user.username }}</strong></p>
    {% else %}
        <p>No autenticado</p>
    {% endif %}

    ---

    {# Mostrar la tabla solo si hay productos #}
    {% if productos %}
        <h2>Lista de Contactos</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Teléfono</th>
                </tr>
            </thead>
            <tbody>
                {% for p in productos %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        
                        {# Columna NOMBRE: Prioriza p.nombre #}
                        <td>
                            {% if p.nombre %}{{ p.nombre }} 
                            {% elif p.name %}{{ p.name }}
                            {% else %}-{% endif %}
                        </td>
                        
                        {# Columna CORREO: Prioriza p.correo #}
                        <td>
                            {% if p.correo %}{{ p.correo }} 
                            {% elif p.email %}{{ p.email }}
                            {% elif p.mail %}{{ p.mail }}
                            {% else %}-{% endif %}
                        </td>
                        
                        {# Columna TELÉFONO: Prioriza p.telefono #}
                        <td>
                            {% if p.telefono %}{{ p.telefono }} 
                            {% elif p.phone %}{{ p.phone }}
                            {% else %}-{% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        
        ---

        {# Bloque de Depuración #}
        <h3>Datos crudos (debug)</h3>
        <pre>{{ productos_json }}</pre>
    {% else %}
        <p>No se encontraron contactos.</p>
    {% endif %}

</body>
</html>